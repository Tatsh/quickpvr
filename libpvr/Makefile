LIBNAME := libpvr
LIBVERSION = 0.0.1
LIBVERSION_SHORT = 0
LIBEXTENSION := so
CXXFLAGS := -std=c++17 -pedantic -Wall -Wextra -Werror
CXX := g++
DESTDIR := /usr
LIBDIR := $(DESTDIR)/lib
INCDIR := $(DESTDIR)/include
OBJECTS = pvr.o pvrtc.o

all: $(LIBNAME).$(LIBEXTENSION)

dylib: $(OBJECTS)
	$(CXX) -dynamiclib $(CXXFLAGS) -current_version $(LIBVERSION) -compatibility_version $(LIBVERSION) -fvisibility=hidden -o $(LIBNAME).A.dylib $(OBJECTS)

dll: $(OBJECTS)
	$(CXX) -o $(LIBNAME).dll $(OBJECTS) -s -shared -Wl,--subsystem,windows

install: $(LIBNAME).$(LIBEXTENSION)
	cp $(LIBNAME).$(LIBEXTENSION) $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT) $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION) $(LIBDIR)
	cp pvr.h $(INCDIR)/pvr.h

$(LIBNAME).$(LIBEXTENSION): $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT)
	rm -f $(LIBNAME).$(LIBEXTENSION)
	ln -s $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT) $(LIBNAME).$(LIBEXTENSION)

$(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT): $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION)
	rm -f $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT)
	ln -s $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION) $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT)

$(LIBNAME).$(LIBEXTENSION).$(LIBVERSION): $(OBJECTS)
	$(CXX) -shared -Wl,-soname,$(LIBNAME).$(LIBEXTENSION).$(LIBVERSION_SHORT) -o $(LIBNAME).$(LIBEXTENSION).$(LIBVERSION) $(OBJECTS)

$(OBJECTS):%.o:%.cc
	$(CXX) $(CXXFLAGS) -fvisibility=hidden -fPIC -c $< -o $@

clean:
	rm -f $(OBJECTS) $(LIBNAME).$(LIBEXTENSION)* $(LIBNAME).*.dylib $(DESTDIR)/$(LIBNAME).$(LIBEXTENSION)* $(DESTDIR)/$(LIBNAME).*.dylib
